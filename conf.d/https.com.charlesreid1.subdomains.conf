####################
#
# charlesreid1.com subdomains
# redirecting to bluebear:
# - pages
# - hooks
# - bots
#
# krash = 45.56.87.232
# bluebear = 206.189.212.168
#
####################

server {
    listen 443;
    listen [::]:443;
    server_name pages.charlesreid1.com;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/pages.charlesreid1.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pages.charlesreid1.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;

    client_max_body_size 100m;
    port_in_redirect off;

    location / {
        # https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_pass http://206.189.212.168:7777/;
        proxy_redirect http://206.189.212.168:7777/ http://pages.charlesreid1.com/;
    }
}

server {
    listen 443;
    listen [::]:443;
    server_name hooks.charlesreid1.com;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/hooks.charlesreid1.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hooks.charlesreid1.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;

    client_max_body_size 100m;

    gzip              on;
    gzip_http_version 1.0;
    gzip_proxied      any;
    gzip_min_length   500;
    gzip_disable      "MSIE [1-6]\.";
    gzip_types        text/plain text/xml text/css
                      text/comma-separated-values
                      text/javascript
                      application/x-javascript
                      application/atom+xml;

    location / {
        # / takes user to static hooks subdomain page
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://206.189.212.168:7778;
    }

    location /webhook {
        # /webhook* anything takes user to port 5000, api
        proxy_set_header   X-Real-IP  $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   Host $host;
        proxy_pass http://206.189.212.168:5000/webhook;
    }
}

server {
    # https://bots.charlesreid1.com
    listen 443;
    listen [::]:443;
    server_name bots.charlesreid1.com;

    ssl on;
    ssl_certificate /etc/letsencrypt/live/bots.charlesreid1.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bots.charlesreid1.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;

    client_max_body_size 100m;
    port_in_redirect off;

    location / {
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass http://206.189.212.168:7779;
        proxy_redirect http://206.189.212.168:7779/ http://bots.charlesreid1.com/;
    }
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name toots.charlesreid1.com;

  ssl_protocols TLSv1.2;
  ssl_ciphers HIGH:!MEDIUM:!LOW:!aNULL:!NULL:!SHA;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;

  ssl_certificate     /etc/letsencrypt/live/toots.charlesreid1.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/toots.charlesreid1.com/privkey.pem;

  keepalive_timeout    70;
  sendfile             on;
  client_max_body_size 80m;

  root /home/mastodon/live/public;

  gzip on;
  gzip_disable "msie6";
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

  add_header Strict-Transport-Security "max-age=31536000";

  location / {
    try_files $uri @proxy;
  }

  location ~ ^/(emoji|packs|system/accounts/avatars|system/media_attachments/files) {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri @proxy;
  }
  
  location /sw.js {
    add_header Cache-Control "public, max-age=0";
    try_files $uri @proxy;
  }

  location @proxy {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Proxy "";
    proxy_pass_header Server;

    proxy_pass http://206.189.212.168:7776;
    proxy_buffering off;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    tcp_nodelay on;
  }

  location /api/v1/streaming {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Proxy "";

    proxy_pass http://206.189.212.168:7775;
    proxy_buffering off;
    proxy_redirect off;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    tcp_nodelay on;
  }

  error_page 500 501 502 503 504 /500.html;
}

